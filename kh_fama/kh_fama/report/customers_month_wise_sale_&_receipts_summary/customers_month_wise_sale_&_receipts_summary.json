{
 "add_total_row": 0,
 "columns": [],
 "creation": "2025-10-14 12:11:54.360156",
 "disable_prepared_report": 0,
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "letter_head": "SILK",
 "modified": "2025-10-17 16:29:58.391537",
 "modified_by": "Administrator",
 "module": "KH Fama",
 "name": "Customers Month Wise Sale & Receipts Summary",
 "owner": "ghaith@srp.ai",
 "prepared_report": 0,
 "ref_doctype": "Sales Invoice",
 "report_name": "Customers Month Wise Sale & Receipts Summary",
 "report_script": "from_date = filters.get(\"from_date\") or \"2000-01-01\"\r\nto_date = filters.get(\"to_date\") or frappe.utils.nowdate()\r\n\r\n# --- SQL Query with closing balance calculation ---\r\nresults = frappe.db.sql('''\r\n    SELECT \r\n        si.customer,\r\n        DATE_FORMAT(si.posting_date, \"%%b %%Y\") AS month,\r\n        -- Opening Balance: sum of outstanding before from_date\r\n        (SELECT SUM(si2.outstanding_amount)\r\n         FROM `tabSales Invoice` si2\r\n         WHERE si2.customer = si.customer\r\n           AND si2.docstatus = 1\r\n           AND si2.posting_date < %(from_date)s\r\n           AND si2.status IN (\"Unpaid\", \"Overdue\")\r\n        ) AS opening,\r\n        -- Receipts: Paid invoices within date range\r\n        SUM(CASE WHEN si.status = \"Paid\" THEN si.grand_total ELSE 0 END) AS receipts,\r\n        -- Sales: Unpaid/Overdue invoices within date range\r\n        SUM(CASE WHEN si.status IN (\"Unpaid\", \"Overdue\") THEN si.grand_total ELSE 0 END) AS sales,\r\n        -- Calculate closing balance directly in SQL\r\n        ((SELECT SUM(si2.outstanding_amount)\r\n         FROM `tabSales Invoice` si2\r\n         WHERE si2.customer = si.customer\r\n           AND si2.docstatus = 1\r\n           AND si2.posting_date < %(from_date)s\r\n           AND si2.status IN (\"Unpaid\", \"Overdue\")\r\n        ) + \r\n        SUM(CASE WHEN si.status IN (\"Unpaid\", \"Overdue\") THEN si.grand_total ELSE 0 END) -\r\n        SUM(CASE WHEN si.status = \"Paid\" THEN si.grand_total ELSE 0 END)) AS customer_ledger\r\n    FROM `tabSales Invoice` si\r\n    WHERE si.docstatus = 1\r\n      AND si.posting_date >= %(from_date)s\r\n      AND si.posting_date <= %(to_date)s\r\n      AND DATE_FORMAT(si.posting_date, \"%%Y-%%m\") <= DATE_FORMAT(%(to_date)s, \"%%Y-%%m\")\r\n    GROUP BY si.customer, DATE_FORMAT(si.posting_date, \"%%Y-%%m\")\r\n    ORDER BY si.customer, DATE_FORMAT(si.posting_date, \"%%Y-%%m\")\r\n''', {\"from_date\": from_date, \"to_date\": to_date}, as_dict=True)\r\n\r\n# --- Get unique months from results ---\r\nmonths = []\r\nfor row in results:\r\n    if row['month'] not in months:\r\n        months.append(row['month'])\r\n\r\n# Simple alphabetical sort\r\nmonths.sort()\r\n\r\n# --- Get unique customers ---\r\ncustomers = []\r\nfor row in results:\r\n    if row['customer'] not in customers:\r\n        customers.append(row['customer'])\r\n\r\n# --- Build final data array ---\r\nfinal_data = []\r\n\r\nfor customer in customers:\r\n    customer_row = {\r\n        'customer': customer,\r\n        'opening': 0,\r\n        'customer_ledger': 0\r\n    }\r\n    \r\n    # Initialize all month columns to 0\r\n    for month in months:\r\n        customer_row[month + '_receipts'] = 0\r\n        customer_row[month + '_sales'] = 0\r\n    \r\n    # Fill data from results\r\n    for row in results:\r\n        if row['customer'] == customer:\r\n            customer_row['opening'] = row['opening'] or 0\r\n            customer_row['customer_ledger'] = row['customer_ledger'] or 0\r\n            customer_row[row['month'] + '_receipts'] = row['receipts'] or 0\r\n            customer_row[row['month'] + '_sales'] = row['sales'] or 0\r\n    \r\n    final_data.append(customer_row)\r\n\r\n# --- Define Columns ---\r\ncolumns = [\r\n    {\"label\": \"Customer\", \"fieldname\": \"customer\", \"fieldtype\": \"Link\", \"options\": \"Customer\", \"width\": 200},\r\n    {\"label\": \"Opening Balance\", \"fieldname\": \"opening\", \"fieldtype\": \"Currency\", \"width\": 150},\r\n]\r\n\r\n# Add monthly columns for receipts and sales\r\nfor month in months:\r\n    columns.append({\"label\": f\"{month} Receipts\", \"fieldname\": f\"{month}_receipts\", \"fieldtype\": \"Currency\", \"width\": 150})\r\n    columns.append({\"label\": f\"{month} Sales\", \"fieldname\": f\"{month}_sales\", \"fieldtype\": \"Currency\", \"width\": 150})\r\n\r\n# Add Customer Ledger column at the end\r\ncolumns.append({\"label\": \"Customer Ledger\", \"fieldname\": \"customer_ledger\", \"fieldtype\": \"Currency\", \"width\": 150})\r\n\r\ndata = columns, final_data",
 "report_type": "Script Report",
 "roles": [
  {
   "role": "Accounts Manager"
  },
  {
   "role": "Accounts User"
  },
  {
   "role": "Employee Self Service"
  },
  {
   "role": "Analytics"
  }
 ]
}